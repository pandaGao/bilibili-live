"use strict";function e(e){return e&&"object"==typeof e&&"default"in e?e.default:e}Object.defineProperty(exports,"__esModule",{value:!0});var t=e(require("ws")),r=e(require("eventemitter3")),n=require("string_decoder"),o=require("zlib");const s=new n.StringDecoder("utf8");function i(e,t=""){const r=Buffer.byteLength(t)+16,n=Buffer.alloc(r);return n.writeInt32BE(r,0),n.writeInt16BE(16,4),n.writeInt16BE(0,6),n.writeInt32BE(e,8),n.writeInt32BE(0,12),n.write(t,16),n}function c(e){let t=0;const r=e.byteLength,n=[];for(;t<r;){const r=e.readInt32BE(t+0),i=e.readInt16BE(t+4),c=e.readInt16BE(t+6),h=e.readInt32BE(t+8),a=e.readInt32BE(t+12);let u="";if(8===h)u="";else if(3===h)u=e.readInt32BE(t+i);else{const n=e.slice(t+i,t+r);2===c?u=o.inflateSync(n):0===c&&(u=JSON.parse(s.write(n)))}t+=r,n.push({packetLength:r,headerLength:i,version:c,operation:h,sequence:a,body:u})}return n}exports.DanmakuService=class extends r{constructor(e={}){super(),this.roomId=e.roomId,this.userId=e.userId||1e15+Math.floor(2e15*Math.random()),this._socket=null,this._heartbeatService=null,this._reconnectService=null,this._checkErrorService=function(e,t=100){let r;const n=function(...n){clearTimeout(r),r=setTimeout(()=>e(...n),t)};return n.cancel=()=>clearTimeout(r),n}(()=>{this.emit("error","check failed"),this.reconnectByError()},3e4)}connect(){return this._socket=new t("wss://broadcastlv.chat.bilibili.com:2245/sub"),this.handleEvents(),this}disconnect(){clearTimeout(this._heartbeatService),clearTimeout(this._reconnectService),this._checkErrorService.cancel(),this._socket.close(),this._socket=null}reconnect(){this.disconnect(),this.connect()}reconnectByError(){this._reconnectService&&clearTimeout(this._reconnectService),this._reconnectService=setTimeout(()=>{this.reconnect()},3e3)}handleEvents(){const e=this._socket;e.on("open",()=>{e===this._socket&&(this.sendJoinRoom(),this.emit("open"))}),e.on("message",t=>{e===this._socket&&(this._checkErrorService(),function(e){const t=[];try{c(e).forEach(e=>{if(2===e.version){c(e.body).forEach(e=>{t.push(e)})}else t.push(e)})}catch(t){console.error("[bilibili-live]: Socket message error",e,t)}return t.reduce((e,t)=>{const r=function(e){switch(e.operation){case 3:return{op:"HEARTBEAT_REPLY",online:e.body};case 5:{const t=[];return e.body.op="SEND_SMS_REPLY",t.push(e.body),t}case 8:return{op:"AUTH_REPLY"}}}(t);return r instanceof Array?r.forEach(t=>{e.push(t)}):r instanceof Object&&e.push(r),e},[])}(t).map(e=>{"AUTH_REPLY"===e.op&&this.sendHeartbeat(),this.emit("data",e)}))}),e.on("close",()=>{e===this._socket&&this.emit("close")}),e.on("error",t=>{e===this._socket&&(this.emit("error",t),this.reconnectByError())})}sendJoinRoom(){this._socket.send(function(e,t,r="3rd_party",n=2){return i(7,JSON.stringify({uid:1*t,roomid:1*e,protover:n,platform:r}))}(this.roomId,this.userId))}sendHeartbeat(){this._socket.send(i(2)),this._heartbeatService=setTimeout(()=>{this.sendHeartbeat()},1e4)}};
