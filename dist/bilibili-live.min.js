"use strict";function e(e){return e&&"object"==typeof e&&"default"in e?e.default:e}Object.defineProperty(exports,"__esModule",{value:!0});var t=e(require("ws")),r=e(require("eventemitter3")),s=require("string_decoder"),i=require("zlib"),o=e(require("got"));const n=new s.StringDecoder("utf8");function c(e,t=""){const r=Buffer.byteLength(t)+16,s=Buffer.alloc(r);return s.writeInt32BE(r,0),s.writeInt16BE(16,4),s.writeInt16BE(0,6),s.writeInt32BE(e,8),s.writeInt32BE(0,12),s.write(t,16),s}function h(e){const t=[];try{!function e(t,r){let s=0;const o=t.byteLength;for(;s<o;){const o=t.readInt32BE(s),c=t.readInt16BE(s+4),h=t.readInt16BE(s+6),a=t.readInt32BE(s+8),u=t.readInt32BE(s+12),l=e=>{r.push({packetLength:o,headerLength:c,version:h,operation:a,sequence:u,body:e})};if(8===a)l("");else if(3===a)l(t.readInt32BE(s+c));else{const a=t.slice(s+c,s+o);if(0===h){l(JSON.parse(n.write(a)))}else 1===h||2===h?e(i.inflateSync(a),r):3===h?e(i.brotliDecompressSync(a),r):console.error("[bilibili-live]: Unhandled body version "+h)}s+=o}}(e,t)}catch(t){console.error("[bilibili-live]: Socket message error",e,t)}return t.reduce((e,t)=>{const r=function(e){switch(e.operation){case 3:return{op:"HEARTBEAT_REPLY",online:e.body};case 5:{const t=[];return e.body.op="SEND_SMS_REPLY",t.push(e.body),t}case 8:return{op:"AUTH_REPLY"}}}(t);return r instanceof Array?r.forEach(t=>{e.push(t)}):r instanceof Object&&e.push(r),e},[])}exports.Client=class{constructor(e={}){this._cookie=e.cookie||"",this._userAgent=e.userAgent||"Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/51.0.2704.103 Safari/537.36",this._referer=e.referer||"https://live.bilibili.com"}getCSRFToken(){if(!this._cookie)return"";let e="";return this._cookie.split(";").some(t=>{const[r,s]=t.split("=");"bili_jct"===r&&(e=s)}),e}getDefaultHeaders(){return{cookie:this._cookie,"user-agent":this._userAgent,referer:this._referer}}get(e,t){const r=Object.assign({},t,{headers:Object.assign(t&&t.headers||{},this.getDefaultHeaders())});return o.get(e,r).text()}getJSON(e,t){const r=Object.assign({},t,{headers:Object.assign(t&&t.headers||{},this.getDefaultHeaders())});return o.get(e,r).json()}post(e,t){const r=Object.assign({},t,{headers:Object.assign(t&&t.headers||{},this.getDefaultHeaders())});return o.post(e,r).json()}},exports.DanmakuService=class extends r{constructor(e={}){super(),this.roomId=e.roomId,this.userId=e.userId||1e15+Math.floor(2e15*Math.random()),this.customAuth=e.customAuth,this._socket=null,this._heartbeatService=null,this._reconnectService=null,this._checkErrorService=function(e,t=100){let r;const s=function(...s){clearTimeout(r),r=setTimeout(()=>e(...s),t)};return s.cancel=()=>clearTimeout(r),s}(()=>{this.emit("error","check failed"),this.reconnectByError()},3e4)}connect(){return this._socket=new t("wss://broadcastlv.chat.bilibili.com:2245/sub"),this.handleEvents(),this}disconnect(){clearTimeout(this._heartbeatService),clearTimeout(this._reconnectService),this._checkErrorService&&this._checkErrorService.cancel(),this._socket&&this._socket.close(),this._socket=null}reconnect(){this.disconnect(),this.connect()}reconnectByError(){this._reconnectService&&clearTimeout(this._reconnectService),this._reconnectService=setTimeout(()=>{this.reconnect()},3e3)}handleEvents(){const e=this._socket;e.on("open",()=>{e===this._socket&&(this.sendJoinRoom(),this.emit("open"))}),e.on("message",t=>{e===this._socket&&(this._checkErrorService(),h(t).map(e=>{"AUTH_REPLY"===e.op&&this.sendHeartbeat(),this.emit("data",e)}))}),e.on("close",()=>{e===this._socket&&this.emit("close")}),e.on("error",t=>{e===this._socket&&(this.emit("error",t),this.reconnectByError())})}sendJoinRoom(){var e;this.customAuth?this._socket.send((e=this.customAuth,c(7,JSON.stringify(e)))):this._socket.send(function(e,t,r="3rd_party",s=2){return c(7,JSON.stringify({uid:1*t,roomid:1*e,protover:s,platform:r}))}(this.roomId,this.userId))}sendHeartbeat(){this._socket.send(c(2)),this._heartbeatService=setTimeout(()=>{this.sendHeartbeat()},1e4)}};
